@page "/riego"
@using System.Timers

<h3>Panel de Riego IoT</h3>

<p>Estado: <b>@estado</b></p>
<p>Tiempo en riego: @tiempoRiego</p>

<button @onclick="ToggleRiego">@botonTexto</button>

@code {
    private string estado = "Apagado";
    private string botonTexto = "Iniciar Riego";
    private DateTime inicio;
    private TimeSpan tiempoRiego;
    private bool enRiego = false;
    private System.Timers.Timer timer;

    protected override void OnInitialized()
    {
        timer = new System.Timers.Timer(1000); // cada segundo
        timer.Elapsed += ActualizarTiempo;
    }

    private void ToggleRiego()
    {
        if (!enRiego)
        {
            estado = "Encendido";
            botonTexto = "Suspender Riego";
            inicio = DateTime.Now;
            enRiego = true;
            timer.Start();
        }
        else
        {
            estado = "Apagado";
            botonTexto = "Iniciar Riego";
            timer.Stop();
            tiempoRiego = DateTime.Now - inicio;
            enRiego = false;

            // Aquí iría la lógica para guardar en Supabase
        }
    }

    private void ActualizarTiempo(object sender, ElapsedEventArgs e)
    {
        if (enRiego)
        {
            tiempoRiego = DateTime.Now - inicio;
            InvokeAsync(StateHasChanged);
        }
    }
}